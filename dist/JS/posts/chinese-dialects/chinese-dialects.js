import scroller from"/dist/JS/scrollytelling/scroller.js";const margin={top:50,right:15,bottom:70,left:55};let svg,counties,circles,radiusScale,colorScale,width=document.getElementById("vis").offsetWidth-margin.left-margin.right-20,height=document.getElementById("vis").offsetHeight-margin.top-margin.bottom,categories=["Chinese (Unspecified)","Mandarin","Cantonese","Hakka","Wu","Kan, Hsiang","Fuchow","Formosan","Total"];var scrollVis=function(){// Which visualization we currently are on
var a=-1,b=0,c=[],d=[],e=function(a){a.each(function(a){f(a),g()})},f=function(a){function b(a){var b=a.getBBox();return[b.x+b.width/2,b.y+b.height/2]}d3.select("#map").style("text-align","center").node().append(a[0].documentElement),svg=d3.select("svg").select("g").style("transition","0.4s all"),svg.select("#State_Lines").style("stroke","white");// Organize data to match it by county
let c={},d=[],e=0,f=[0,0];a[1].forEach(function(a){c[a.County]=a}),svg.select("#stylegroup").selectAll("path").style("stroke","white").each(function(){let a=d3.select(this).select("title").text();a in c&&(c[a].center=b(this),c[a].fullName="Baltimore County, MD"==c[a].County||"Baltimore, MD"==c[a].County?c[a].County:c[a].County.split(",")[0]+" County,"+c[a].County.split(",")[1],d.push(c[a]),e=Math.max(e,c[a].Total),f[0]=Math.min(c[a].Cantonese-c[a].Mandarin,f[0]),f[1]=Math.max(c[a].Cantonese-c[a].Mandarin,f[1]),d3.select(this).attr("class","path"))}),radiusScale=d3.scaleSqrt().domain([0,e]).range([0,40]),colorScale=d3.scaleDiverging().domain([f[0],0,f[1]]).interpolator(d3.interpolatePuOr);// Add Legend
let g=svg.node().getBBox(),h=[1e5,1e4,1e3];d3.select("#map").append("div").attr("class","color-scale").style("position","absolute").style("background-image","linear-gradient(to right, #330554, #9084B9, #f0eded, #F8B562, #853F07)").style("width","280px").style("height","20px").style("bottom","20px").style("left","20px").style("font-size","12px").style("padding","3px 15px").style("position","relative").style("display","none").style("transition","0.4s all").style("transform","rotate(90deg) translate(-140px, 140px)").append("div").style("position","absolute").style("top","-20px").style("left","0").style("right","0").html("\u27F5 More Mandarin<span style = 'margin-right: 30px;'></span>More Cantonese \u27F6"),svg.append("g").selectAll("circle").data(h).enter().append("circle").attr("cx",g.width-radiusScale(h[0])).attr("cy",(a,b)=>g.height-radiusScale(a)-h.slice(0,b).reduce(function(b,a){return b+2*radiusScale(a)+5},0)).attr("r",a=>radiusScale(a)),svg.append("text").text("100k").style("text-anchor","middle").style("font-size","8").attr("x",g.width-radiusScale(1e5)).attr("y",g.height-radiusScale(1e5)+2),svg.append("text").text("1k").style("text-anchor","middle").style("font-size","8").attr("x",g.width-radiusScale(1e5)).attr("y",g.height-2*radiusScale(1e5)-2*radiusScale(1e4)-radiusScale(1e3)-17),counties=svg.select("#stylegroup").selectAll(".path").data(d),circles=svg.select("#stylegroup").selectAll("circle").data(d).enter().append("circle").attr("cx",a=>a.center[0]).attr("cy",a=>a.center[1]),svg.selectAll("circle").style("fill","rgba(102, 51, 153, 0.15)").style("stroke","rgba(102, 51, 153, 0.5)").style("stroke-width",1).style("transition","0.2s all")},g=function(){c[0]=function(){circles.attr("r",function(a){return radiusScale(a.Total)})},d[0]=function(){},c[1]=function(){circles.attr("r",function(a){return radiusScale(a.Mandarin)})},d[1]=function(){},c[2]=function(){circles.attr("r",function(a){return radiusScale(a.Cantonese)})},d[2]=function(){},c[3]=function(){circles.attr("r",function(a){return 0<a.Cantonese-a.Mandarin?radiusScale(a.Cantonese-a.Mandarin):0})},d[3]=function(){},c[4]=function(){circles.attr("r",function(a){return 0<a.Mandarin-a.Cantonese?radiusScale(a.Mandarin-a.Cantonese):0}),svg.attr("transform","translate(0, 0) scale(1)"),counties.style("fill","d0d0d0"),d3.select(".color-scale").style("display","none")},d[4]=function(){},c[5]=function(){svg.attr("transform","translate(50, -800) scale(7)"),counties.style("fill",a=>colorScale(a.Cantonese-a.Mandarin)),circles.attr("r",0),d3.select(".color-scale").style("display","block")},d[5]=function(){},c[6]=function(){svg.attr("transform","translate(-2700, -500) scale(6)")},d[6]=function(){}};// return chart function
return e.activate=function(d){b=d;var e=0>b-a?-1:1,f=d3.range(a+e,b+e,e);f.forEach(function(a){c[a]()}),a=b},e.update=function(a,b){d[a](b)},e};// Load data, then display
Promise.all([d3.xml("/data/chinese-dialects/usa_counties.svg"),d3.csv("/data/chinese-dialects/languages.csv")]).then(function(a){var b=scrollVis();d3.select("#vis").datum(a).call(b);var c=scroller().container(d3.select("#scrolling-vis"));c(d3.selectAll(".step")),c.on("active",function(a){d3.selectAll(".step").classed("active",function(b,c){return c===a}).style("opacity",function(b,c){return c===a?1:.1}),b.activate(a)}),c.on("progress",function(a,c){b.update(a,c)});let d;// Handle Resize
d3.select(window).on("resize",function(){clearTimeout(d),d=setTimeout(function(){},50)})}).catch(function(a){// handle error here
console.log(a)});